---
title: 系统分析师（软考）--主存与缓存的映射关系
tags: [analysis]
---

参考：http://blog.163.com/zjf_to/blog/static/201429061201212010305476/

参考：http://blog.csdn.net/stardhb/article/details/44900509

Cache和CPU以及存储器的关系：

![](/images/book/tech-analysis/memory/cacheposition.png)

### 1. 缓存概念

CPU对存储器的访问，通常是一次读写一个字单元。当CPU访Cache不命中时，需将存储在主存中的字单元连同其后若干个字一同调入Cache中，之所以这样做，是为了使其后的访存能在Cache中命中（程序的空间局部性原理）。因此，主存和Cache之间一次交换的数据单位应该是一个数据块。数据块的大小是固定的，由若干个字组成，且主存和Cache的数据块大小是相同的。

从Cache-主存层次实现的目标看，一方面既要使CPU的访存速度接近于访Cache的速度（提高访问内存速度），另一方面为用户程序提供的运行空间应保持为主存容量大小的存储空间。在采用Cache-主存层次的系统中，Cache对用户程序而言是透明的，也就是说，用户程序可以不需要知道Cache的存在。因此，CPU每次访存时，依然和未使用Cache的情况一样，给出的是一个主存地址。但在Cache-主存层次中，CPU首先访问的是Cache，并不是主存。为此，需要一种机制将CPU的访主存地址转换成访Cache地址。而主存地址与Cache地址之间的转换是与主存块与Cache块之间的映射关系紧密联系的，也就是说，当CPU访Cache未命中时，需要将欲访问的字所在主存中的块调入Cache中，按什么样的策略调入，直接影响到主存地址与Cache地址的对应关系，这也就是本小节要解决的主存与Cache的地址映射问题。

### 2. 主存与cache的映射关系

主要有三种地址映射方式，分别为全相联映射、直接相联映射和组相联映射，主要是为了主存调入cache策略。

注：装入时都是按块大小进行装入的

### 3. 全相联映射

1）映射关系

地址映象规则：主存的任意一块可以映象到Cache中的任意一块

(1) 分块：主存与缓存分成相同大小的数据块。

(2) 映射：主存的某一数据块可以装入缓存的任意一块空间中。

全相联映射是指主存中任一块都可以映射到Cache中任一块的方式，也就是说，当主存中的一块需调入Cache时，可根据当时Cache的块占用或分配情况，选择一个块给主存块存储，所选的Cache块可以是Cache中的任意一块。例如，设Cache共有2C块，主存共有2M块，当主存的某一块j需调进Cache中时，它可以存入Cache的块0、块1、…、块i、… 或块2C-1的任意一块上。

映射关系：

![](/images/book/tech-analysis/memory/allcache.jpg)

2）地址转换

主存地址到Cache地址的转换是通过查找一个由相联存储器实现的块表来完成的。

![](/images/book/tech-analysis/memory/allcacheref.jpg)

在全相联映射方式下，CPU的访主存地址为如下形式：

![](/images/book/tech-analysis/memory/memaddressall.jpg)

注：M为主存的块号，W为块内的字号。

CPU访Cache的地址形式为：

![](/images/book/tech-analysis/memory/cacheaddressall.jpg)

注：C为Cache的块号，W为块内的字号。

3）执行过程

当一个主存块调入Cache中时，会同时在一个存储主存块号和Cache块号映射表的相联存储器中进行登记。CPU访存时，首先，根据主存地址中的主存块号M在相联存储器中查找Cache块号，若找到，则本次访Cache命中，于是将对应的Cache块号取出，并送访Cache地址的块号C字段；紧接着将主存地址的块内字号W直接送Cache地址的块内字号W字段，从而形成一个访Cache的地址；最后根据该地址完成对Cache单元的访问.

优点：命中率比较高，Cache存储空间利用率高。

缺点：访问相关存储器时，每次都要与全部内容比较，速度低，成本高，因而应用少。

![](/images/book/tech-analysis/memory/memallproc.png)

4）举例：

某机主存容量为1M，Cache的容量为32KB， 每块的大小为16个字（或字节）。 划出主、缓存的地址格式、 目录表格式及其容量。

![](/images/book/tech-analysis/memory/memallexam.gif)

### 4. 直接相联映射

1）映射关系

地址映象规则： 主存储器中一块只能映象到Cache的一个特定的块中

(1) 分块：主存与缓存分成相同大小的数据块。

(2) 主存分区：主存容量应是缓存容量的整数倍，将主存空间按缓存的容量分成区，主存中每一区的块数与缓存的总块数相等。

(3) 映射：主存中某区的一块存入缓存时只能存入缓存中块号相同的位置。

主存中各区内相同块号的数据块都可以分别调入缓存中块号相同的地址中，但同时只能有一个区的块存入缓存。由于主、缓存块号相同，因此，目录登记时，只记录调入块的区号即可。

![](/images/book/tech-analysis/memory/memdirectref.gif)

2）地址转换

地址转换涉及主、 缓冲地址格式、目录表的格式及地址变换规则。主、缓存块号及块内地址两个字段完全相同。目录表存放在高速小容量存储器中，其中包括二部分：数据块在主存的区号和有效位。目录表的容量与缓存的块数相同。

3）执行过程

用主存地址中的块号B去访问目录存储器，把读出来的区号与主存地址中的区号E进行比较，比较结果相等，有效位为1，则Cache命中，可以直接用块号及块内地址组成的缓冲地址到缓存中取数；比较结果不相等，有效位为1，可以进行替换，如果有效位为0，可以直接调入所需块。

![](/images/book/tech-analysis/memory/memdirectproc.png)

优点：地址映象方式简单，数据访问时，只需检查区号是否相等即可，因而可以得到比较快的访问速度，硬件设备简单。

缺点：替换操作频繁，命中率比较低。

4）实例

主存容量为1M， Cache的容量为32KB，每块的大小为16个字（或字节）。划出主、缓存的地址格式、目录表格式及其容量。

![](/images/book/tech-analysis/memory/memdirectexame.png)

### 5. 组相联映象方式

1）映射关系

(1) 分块：主存和Cache按同样大小划分成块。

(2) 分组：主存和Cache按同样大小划分成组。

(3) 分区：主存容量是缓存容量的整数倍，将主存空间按缓冲区的大小分成区，主存中每一区的组数与缓存的组数相同。

(4) 当主存的数据调入缓存时，主存与缓存的组号应相等，也就是各区中的某一块只能存入缓存的同组号的空间内，但组内各块地址之间则可以任意存放， 即从主存的组到Cache的组之间采用直接映象方式；在两个对应的组内部采用全相联映象方式。

主存地址=区号+组号+组内块号+块内地址号

缓存地址=组号+组内块号+块内地址号

![](/images/book/tech-analysis/memory/cachegroupref.png)

组相联的映象关系，图中缓存共分Cg个组，每组包含有Gb块；主存是缓存的Me倍，所以共分有Me个区，每个区有Cg组，每组有Gb块。那么，主存地址格式中应包含4个字段：区号、区内组号、组内块号和块内地址。而缓存中包含3个字段：组号、组内块号、块内地址。主存地址与缓存地址的转换有两部分，组地址是按直接映象方式，按地址进行访问，而块地址是采用全相联方式，按内容访问。组相联的地址转换部件也是采用相关存储器实现。

2）地址转换

相关存储器中每个单元包含有： 主存地址中的区号E与组内块号B，两者结合在一起，其对应的字段是缓存块地址b。相关存储器的容量，应与缓存的块数相同。当进行数据访问时，先根据组号，在目录表中找到该组所包含的各块的目录，然后将被访数据的主存区号与组内块号，与本组内各块的目录同时进行比较。如果比较相等，而且有效位为"1"则命中。将其对应的缓存块地址b送到缓存地址寄存器的块地址字段，与组号及块内地址组装即形成缓存地址。如果比较不相等，说明没命中，所访问的数据块尚没有进入缓存，则进行组内替换；如果有效位为0，则说明缓存的该块尚未利用，或是原来数据作废，可重新调入新块。

![](/images/book/tech-analysis/memory/memgroupproc.png)

3）运行过程

（1）先根据主存地址的组号到块表（关系映射表）中查找出该组号对应的所有块。

（2）将被访数据的主存区号与组内块号，与本组内各块的目录同时进行比较，且有效位为"1"则命中。

（3）若命中则将其对应的缓存块地址b（组内块号）送到缓存地址寄存器的块地址字段，与组号及块内地址组装即形成缓存地址（因为组内块号的对应关系是全相连映射的）。

注：关系映射表的长度与cache的块数量相同

4）实例

主存容量为1M， Cache的容量为32KB，每块的大小为16个字（或字节），共分4组。划出主、缓存的地址格式、目录表格式及其容量。

![](/images/book/tech-analysis/memory/memgroupexame.png)