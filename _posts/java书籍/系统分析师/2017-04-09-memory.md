---
title: 系统分析师（软考）--主存与缓存的映射关系
tags: [analysis]
---

参考：http://blog.163.com/zjf_to/blog/static/201429061201212010305476/

参考：http://blog.csdn.net/stardhb/article/details/44900509

### 1. 缓存概念

CPU对存储器的访问，通常是一次读写一个字单元。当CPU访Cache不命中时，需将存储在主存中的字单元连同其后若干个字一同调入Cache中，之所以这样做，是为了使其后的访存能在Cache中命中（程序的空间局部性原理）。因此，主存和Cache之间一次交换的数据单位应该是一个数据块。数据块的大小是固定的，由若干个字组成，且主存和Cache的数据块大小是相同的。

从Cache-主存层次实现的目标看，一方面既要使CPU的访存速度接近于访Cache的速度（提高访问内存速度），另一方面为用户程序提供的运行空间应保持为主存容量大小的存储空间。在采用Cache-主存层次的系统中，Cache对用户程序而言是透明的，也就是说，用户程序可以不需要知道Cache的存在。因此，CPU每次访存时，依然和未使用Cache的情况一样，给出的是一个主存地址。但在Cache-主存层次中，CPU首先访问的是Cache，并不是主存。为此，需要一种机制将CPU的访主存地址转换成访Cache地址。而主存地址与Cache地址之间的转换是与主存块与Cache块之间的映射关系紧密联系的，也就是说，当CPU访Cache未命中时，需要将欲访问的字所在主存中的块调入Cache中，按什么样的策略调入，直接影响到主存地址与Cache地址的对应关系，这也就是本小节要解决的主存与Cache的地址映射问题。

### 2. 主存与cache的映射关系

主要有三种地址映射方式，分别为全相联映射、直接相联映射和组相联映射，主要是为了主存调入cache策略。

### 3. 全相联映射

1）映射关系



全相联映射是指主存中任一块都可以映射到Cache中任一块的方式，也就是说，当主存中的一块需调入Cache时，可根据当时Cache的块占用或分配情况，选择一个块给主存块存储，所选的Cache块可以是Cache中的任意一块。例如，设Cache共有2C块，主存共有2M块，当主存的某一块j需调进Cache中时，它可以存入Cache的块0、块1、…、块i、… 或块2C-1的任意一块上。

映射关系：

![](/images/book/tech-analysis/memory/allcache.jpg)

2）地址转换

主存地址到Cache地址的转换是通过查找一个由相联存储器实现的块表来完成的。

![](/images/book/tech-analysis/memory/allcacheref.jpg)

在全相联映射方式下，CPU的访主存地址为如下形式：

![](/images/book/tech-analysis/memory/memaddressall.jpg)

注：M为主存的块号，W为块内的字号。

CPU访Cache的地址形式为：

![](/images/book/tech-analysis/memory/cacheaddressall.jpg)

注：C为Cache的块号，W为块内的字号。

3）执行过程

当一个主存块调入Cache中时，会同时在一个存储主存块号和Cache块号映射表的相联存储器中进行登记。CPU访存时，首先，根据主存地址中的主存块号M在相联存储器中查找Cache块号，若找到，则本次访Cache命中，于是将对应的Cache块号取出，并送访Cache地址的块号C字段；紧接着将主存地址的块内字号W直接送Cache地址的块内字号W字段，从而形成一个访Cache的地址；最后根据该地址完成对Cache单元的访问.

全相联映射方式的优点是Cache的空间利用率高，但缺点是相联存储器庞大（映射关系存储器机构），比较电路复杂，因此只适合于小容量的Cache之用。

### 4. 直接相联映射

直接相联映射方式是指主存的某块j只能映射到满足特定关系的Cache块i中：