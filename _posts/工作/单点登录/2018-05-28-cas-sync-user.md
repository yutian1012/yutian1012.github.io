---
title: 单点登录用户同步问题的思考
tags: [cas]
---

参考：http://fandayrockworld.iteye.com/blog/1007953

单点登录的一个主要问题点是用户数据同步问题。

在单点登录中，所有的系统共用一个用户中心当然是最好的选择。但由于系统是由不同时期创建，并且可能来来自不同的开发商，同一个用户中心不太现实。这就涉及到了，多个系统中如何实现用户同步，来实现单点登录。

1）cas服务器端维护所有的用户信息（独立数据库）

这就涉及到所有的对接系统要实现用户的同步，从同步方向上可以分为单向同步和双向同步。

a.单向同步

即对接系统将自己系统的用户注册信息发送到cas服务器，cas服务器会保持到自己独有的库中。而对接系统不需要从cas服务器同步用户。

登录系统时，由于拦截器的存在会向cas发送请求，这个过程是使用浏览器重定向的功能实现的（为了解决跨域问题）。这样就会将浏览器其中cas服务器保存的cookie信息一并提交到cas服务器端。cas服务器端通过cookie判断用户是否登录。

cas服务器判断如果用户已经登录了，则会重定向到待登录的系统，并在url后拼接上ticket。待登录系统获取ticket，然后再向cas服务器请求ticket对应的用户信息（如获取用户的用户名），通过用户名等信息加载本系统的用户信息，如果存在该用户则能够成功登录（所以，如果对接系统不同步cas服务器，则可能不存在相应的用户），如果不存在则登录失败，要求用户重新登录。即使有其他自己系统独有账号登录。

cas服务器判断如果用户未登录，则会跳转到cas服务器的登录界面进行登录。cas服务器会使用自己持有的数据库进行用户登录判断，如果登录成功，cas服务器向浏览器写入cookie（记录登录成功的cookie），同时以ticket为参数再重定向到待登录系统，实现登录认证。

b.双向同步

对接系统除了将自己的用户信息同步到cas服务器端，同时也需要接收cas服务器端发送过来的用户，将用户信息保存到自己的数据库中。这样，所有对接的系统在用户账号上就达成了一致。这样能够保证一方登录，其他系统一定能成功登录，因为各个系统都有相同的账号。

2）cas服务器不维护用户信息（没有独立的数据库）

cas登录认证的实现：

cas服务器判断如果用户已经登录了，按照上面的方式进行对接系统的登录即可（ticket获取用户名，从对接系统本地加载实现登录）。

cas服务器判断如果用户未登录（此时，不再是有cas服务器端查询自己的数据库进行认证，而是交由待登录系统进行认证），则会跳转到cas服务器的登录界面进行登录。该界面中包含了待访问系统的url。当用户输入用户名、密码后点击登录，cas服务会通过url向待访问系统发出登录请求，待登录系统判断能否登录成功，将登录结果返回cas服务器，如果登录成功，cas服务器向浏览器写入cookie（记录登录成功的cookie），同时以ticket为参数再重定向到待登录系统，实现登录认证。

各个对接系统都是有自己独立的用户信息，cas服务器只用来进行统一用户认证，而不保存用户数据。用户信息可以在多个系统间进行同步。按照系统不同安全等级的要求，实现同步方式也不同。

a.单向同步

以A系统和B系统同步用户为例，A系统要求较严格，不允许同步B系统的用户，而B系统要求不严格，可以同步A系统的用户。这样就会造成A系统登录的用户，一定能成功登录B系统，而B系统登录的用户却不一定能登录A系统。只能实现单向的单点登录和部分双向单点登录。

b.双向同步

即A系统和B系统都需要同步对方的用户，能够实现单点登录。

3）问题

对于用户同步问题，是cas实现单点登录无法绕开的问题。如果cas服务器端不为会独立的用户数据库，那么如果对接系统比较多时，需要两两同步用户，操作会更加复杂（每个对接系统都要维护一个待同步系统的集合，该集合中包含了待同步系统的地址信息）。而如果有一个中心同步数据库，那么，只需要待同步系统与中心数据库交互实现同步即可。



