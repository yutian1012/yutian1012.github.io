---
title: 大文件的查找与删除
tags: [linux]
---

场景：前两天突然被告知linux系统的根目录所在处分区已使用了100%，造成系统响应缓慢，甚至不能登录。

### 分析问题

1）分析

先定位分区，再定位分区下的大目录，最后定位目录下的大文件。

使用df命令，查看系统的分区使用情况，发现系统的根目录挂接的分区已经显示了100%，avail可用空间不足1G。

```
# df命令可以查看分区的使用情况
df -h
```

注：-h表示以方便人类（human）阅读法方式展现大小信息，如显示为2M，而不是字节数量

如何定位大的文件或目录？

```
# du查看根目录下的第一层文件或目录的占用空间
du / -h --max-depth=1
# 查询大的目录的另外一种方式，而且加了排序
du -s /* |sort -nr|head -5

# 使用find查找大文件（遍历所有的目录，包括子目录）
find / -type f -size +800M | xargs ls -lh
```

最终定位到tomcat中的catalina.out文件，该文件已经达到44G大小。

2）操作分析

通过上面的命令已经成功的定位到了大文件，只需要将该文件压缩、备份、删除，并将备份文件移动到备份分区中即可。

分析：通过定位文件发现，大文件是运行在tomcat中的catalina.out文件，该文件输出了tomcat中运行的应用程序的输出，仔细观察该文件，发现输出的日子信息的DEBUG，因此，在应用中设置的log4j的输出级别为DEBUG，修要应用的日志输出级别为ERROR。

### 操作过程

1）关闭应用，修改应用下log4j的日志的输出级别为ERROR

```
# 查找进程，该命令会输出执行的命令信息
pgrep java | xargs ps
# 杀掉进程，该命令会杀掉所有的java进程，这里只想杀掉tomcat进程
pkill -9 java
# 使用kill命令，传递pid杀掉指定进程
kill -9 29808
```

2）备份catalina.out文件，压缩并移动到备份分区中

```
tar -zcvf /bak/log/catalina.out.tar.gz /usr/local/apache-tomcat-7.0.73/logs/catalina.out
rm -f /usr/local/apache-tomcat-7.0.73/logs/catalina.out
```

3）再次df，如果没有成功释放掉空间，需要手动杀掉占用文件的进程，这样空间才能真正的释放掉。

### 空间未释放问题

参考：https://www.cnblogs.com/smail-bao/p/5542444.html

场景：删除了大文件，再次运行df命令发现文件系统并没有释放空间，此时根目录依然显示占用100%？

分析：一般说来不会出现删除文件后空间不释放的情况，但是也存在例外，比如文件被进程锁定，或者有进程一直在向这个文件写数据等等。

思路：一个文件在文件系统中的存放分为两个部分：数据部分和指针部分，指针位于文件系统的meta-data中，数据被删除后，这个指针就从meta-data中清除了，而数据部分存储在磁盘中，数据对应的指针从meta-data中清除后，文件数据部分占用的空间就可以被覆盖并写入新的内容，之所以出现删除catalina.out文件后，空间还没释放，就是因为tomcat进程还在一直向这个文件写入内容，导致虽然删除了catalina.out文件，但文件对应的指针部分由于进程锁定，并未从meta-data中清除，而由于指针并未被删除，那么系统内核就认为文件并未被删除，因此通过df命令查询空间并未释放也就不足为奇了。

1）查看catalina.out文件是否被占用

```
# fuser会输出占用文件的进程号pid
fuser /usr/local/apache-tomcat-7.0.73/logs/catalina.out
# 使用lsof命令
lsof | grep catalina.out
```

2）删除占用文件进程

```
kill -9 pid
```

再次使用df命令查看分区的使用情况，发现此时空间的占用已经不是100%，即成功的解决了大文件导致磁盘空间满的问题。