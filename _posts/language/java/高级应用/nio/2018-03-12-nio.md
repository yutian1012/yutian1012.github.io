---
title: NIO
tags: [java]
---

参考：https://www.cnblogs.com/geason/p/5774096.html

参考：http://www.importnew.com/22623.html

1）NIO的介绍

NIO（java non-blocking IO）引入了一种基于通道和缓冲区的I/O方式，它可以使用Native函数库直接分配堆外内存，然后通过一个存储在Java堆的DirectByteBuffer对象作为这块内存的引用进行操作，避免了在Java堆和Native堆中来回复制数据。

2）背景

java应用程序更多的是受传统IO的束缚，也就是将时间花在等待数据传输上。NIO就是为了减少IO的等待时间，从而提升IO的效率而被提出的。

JNI虽然可以利用底层操作系统的本地方法提高效率，但无法在跨平台的系统间共享代码。NIO设计了新的框架，即能够利用系统的高效IO，同时又能够在多个平台间使用。

对于特殊操作系统的独有特性，java.nio.channels.spi还提供了新的服务提供接口（SPI），允许接入新型通道和选择器，同时又不违反规范的一致性。从而利用系统的特性开发出更高质量的IO操作。

3）NIO的同步和非阻塞

NIO是一种同步非阻塞的IO模型。同步是指线程不断轮询IO事件是否就绪，非阻塞是指线程在等待IO的时候，可以同时做其他任务。

a.同步核心

同步的核心就是Selector对象，Selector代替了线程本身进行轮询IO事件。避免了阻塞，同时减少了不必要的线程消耗；

b.非阻塞核心

非阻塞的核心就是通道和缓冲区，当IO事件就绪时，可以先写入缓冲区，保证IO的成功，而无需线程阻塞式地等待。

4）缓冲区的理解

当一个链接建立完成后，IO的数据未必会马上到达，为了当数据到达时能够正确完成IO操作，在BIO（阻塞IO）中，等待IO的线程必须被阻塞，以全天候地执行IO操作。为了解决这种IO方式低效的问题，引入了缓冲区的概念，当数据到达时，可以预先被写入缓冲区，再由缓冲区交给线程，因此线程无需阻塞地等待IO。

5）通道的理解

通道可读可写（而流只能是单向的），对于离开缓冲区的传输，您想传递出去的数据被置于一个缓冲区，被传送到通道。对于传回缓冲区的传输，一个通道将数据放置在您所提供的缓冲区中。

*注：通道是I/O传输发生时通过的入口，而缓冲区是这些数据传输的来源或目标。*

6）Selector选择器

通道和缓冲区的机制，使得线程无需阻塞地等待IO事件的就绪，但是总是要有人来监管这些IO事件。这个工作就交给了selector来完成，这就是所谓的同步。

Selector允许单线程处理多个Channel。如果你的应用打开了多个连接（通道），但每个连接的流量都很低，使用Selector就会很方便。

要使用Selector，得向Selector注册Channel，然后调用它的select()方法。这个方法会一直阻塞到某个注册的通道有事件就绪，这就是所说的轮询。一旦这个方法返回，线程就可以处理这些事件。

*注：selector只有同时存在多个channel时才有意义。selector是为了管理channel而存在的*