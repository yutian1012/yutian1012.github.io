---
title: JNI中的字符串类型
tags: [jni]
---

JNI中的jstring类型表示在Java虚拟机中的String类型。而在c语言中使用字符数组表示字符串。JNI支持把java的String类型转换成UTF-8/unicode的字符数组，或反过来转换。

一个C语言开发的系统想要与Java开发的系统整合。需要使用jni定义的c的数据结果来作为中间媒介。如c语言的char*数组或字符指针，先转换成jstring，然后又jstring向jvm中传递数据，即将jstring封装成jvm中的String类型。

实例：JNI实现java向c传递字符串数据，同时接收c传递给java的字符串数据。

参考：http://blog.csdn.net/wangkr111/article/details/7883461

1）java类调用本地方法

新建Prompt.java文件

```
public class Prompt {
//定义一个string类型的数据，同时传递java的string类型
//并且接收c/c++语言返回的字符串（字符数组）
    private native String getLine(String prompt);
    public static void main(String args[]) {
        Prompt p = new Prompt();
        String input = p.getLine("Type a line: ");
        System.out.println("User typed: " +input);
    }
    static {
        System.loadLibrary("Prompt");
    }
}
```

2）编译并生成.h头文件

```
# 编译java类
javac -encoding gbk Prompt.java
# 生成java头文件
javah Prompt
```

生成的头文件

```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class Prompt */

#ifndef _Included_Prompt
#define _Included_Prompt
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     Prompt
 * Method:    getLine
 * Signature: (Ljava/lang/String;)Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_Prompt_getLine
  (JNIEnv *, jobject, jstring);

#ifdef __cplusplus
}
#endif
#endif
```

3）新建Prompt.c的实现代码

```
#include "jni.h"
#include "Prompt.h"
#include <string.h>

//方法中的jstring类型的对象接收java传递的字符串
JNIEXPORT jstring JNICALL Java_Prompt_getLine(JNIEnv *env, jobject obj, jstring prompt){
    const char * str;//定义常量指针，用来接收java传递的数据
    str = (*env)->GetStringUTFChars(env,prompt,0);
    if(str==NULL){
        return NULL;
    }
    
    printf("%s",str);//输出字符串数据

    char c[120] = "hello 2017";
    //把chr拼接到c
    strcat(c,str);

    (*env)->ReleaseStringUTFChars(env,prompt,str);

    //返回数据，需要先将c中的string包装成jstring，然后返回
    jstring rtstr=(*env)->NewStringUTF(env,c);
    return rtstr;
}
```

注：通信双方都需要通过jstring进行一个包装和转换。

4）生成动态库并运行

```
gcc -I%JAVA_HOME%\include -I%JAVA_HOME%\include\win32 -shared -Wl,--kill-at -s -o Prompt.dll Prompt.c

# 运行java命令
java Prompt
```

5）新建Prompt.cpp文件

```
#include "jni.h"
#include "Prompt.h"
#include <iostream>

//方法中的jstring类型的对象接收java传递的字符串
JNIEXPORT jstring JNICALL Java_Prompt_getLine(JNIEnv *env, jobject obj, jstring prompt){
    const char * str;//定义常量指针，用来接收java传递的数据
    str = env->GetStringUTFChars(prompt,NULL);
    if(str==NULL){
        return NULL;
    }
    std::cout << str << std::endl;

    env->ReleaseStringUTFChars(prompt,str);

    //返回数据，需要先将char*包装成jstring，然后返回
    jstring rtstr=env->NewStringUTF("return string successed");
    return rtstr;
}
```

6）编译c文件并运行

```
g++ -m64 -I%JAVA_HOME%\include -I%JAVA_HOME%\include\win32 Prompt.cpp -c -o Prompt.dll

# 运行java命令
java Prompt
```

错误提示：jni 提示c++程序不是有效的