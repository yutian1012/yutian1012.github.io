---
title: Java调用本地c程序
tags: [jni]
---

在E盘的work/test目录下新建jni目录，所有的代码都在该目录下实现

```
# 代码目录组织方式
E:/work/test/jni
```

1）编写带有native声明的方法的java类

新建HelloWorld.java文件，并编辑内容

```
package org.sjq.test.jni;

public class HelloWorld {
    //native关键词修饰的都是对本地的声明
    public native void displayHelloWorld();
    static {
        //载入本地库
        System.loadLibrary("hello");
    }
    public static void main(String[] args) {
        //new出java对象，调用本地方法
        new HelloWorld().displayHelloWorld();
    }
}
```

注：这里的本地库hello...

2）使用javac命令编译所编写的java类

```
# 切换目录，定位到HelloWorld.java文件
cd e:\work\test\jni
# 运行javac命令，编译文件，这里可以指定编码，也可以不指定
javac -encoding gbk -d . HelloWorld.java
```

注：-d在当前目录下生成java的package目录

注2：不要txt编辑java文件后保存成UTF-8，会出现非法字符:'\ufeff'，主要是BOM头问题。

3）使用javah生成扩展名为h的头文件

在生成h的头文件时需要使用java编译后的class文件。

```
# 切换目录，定位到HelloWorld.java文件
cd e:\work\test\jni
# 生成头文件
javah org.sjq.test.jni.HelloWorld
```

头文件org_sjq_test_jni_HelloWorld.h（前面为包名，后面为类名，使用下划线分隔）

```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class org_sjq_test_jni_HelloWorld */

#ifndef _Included_org_sjq_test_jni_HelloWorld
#define _Included_org_sjq_test_jni_HelloWorld
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     org_sjq_test_jni_HelloWorld
 * Method:    displayHelloWorld
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_org_sjq_test_jni_HelloWorld_displayHelloWorld
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

4）编写本地方法

方法名要与javah命令生成的头文件里面声明的方法名相同的方法，即这里的Java_org_sjq_test_jni_HelloWorld_displayHelloWorld。

在当前目录下创建c文件hello.c

```
#include "jni.h"
#include "org_sjq_test_jni_HelloWorld.h"
 
//#include otherheaders
 
JNIEXPORT void JNICALL
Java_org_sjq_test_jni_HelloWorld_displayHelloWorld(JNIEnv *env, jobject obj)
{
    printf("Helloworld!\n");
    return;
}
```

注：jni.h文件位于%JAVA_HOME%/include文件夹下，程序中的JNIEnv、jobject等类型都是在该头文件中定义的，否则在编译c时会错误。

5）生成动态库

在windows系统下生成dll动态链接库，并且连接库的名称要与java类加载的library名称相同。

```
gcc -I%JAVA_HOME%\include -I%JAVA_HOME%\include\win32 -shared -Wl,--kill-at -s -o hello.dll hello.c
```


a.参数-I

大写字母I，include的意思是加入自己的库，也就是告诉编译器jni.h的位置。当然不加这个参数也可以，自己把jni.h和jni_md.h文件复制出来和hello.c放一起，另外include改为双引号。

b.参数-shared

表示编译成.dll库文件

c.参数-s

可以大幅减小.dll文件的大小，不加也可以

d.参数-o

表示目标文件名，不加也可以，会有默认名，但要自己改成java中导入库的名字，这里是hello。

e.-Wl,–kill-at

防止编译后的函数名被自动加上@符号，并取消警告。W后是小写字母L，不是数字1。

5）运行测试

```
java org.sjq.test.jni.HelloWorld
```

6）文件目录结构

![](/images/middleware/jni/java-jni-c.png)