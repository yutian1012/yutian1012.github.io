---
title: jvm 内存
tags: [interview]
---

1）内存管理

JVM可以让你专注于业务的编写，不需要管理内存的分配和回收。JVM能够自动进行内存的管理，这既是优点也是缺点。当JVM出现内存泄漏时，需要了解JVM如何对内存进行管理的，从而实现错误定位和修复。

注：代码可以理解为数据流，指令流和控制流的组合。数据可以理解为变量（成员变量和局部变量），指令即方法中的代码（赋值，加减等），控制（分支，循环，return等）。这些信息是如何在JVM中存储和运行是理解JVM的关键。

2）JVM运行时数据区

JVM运行时数据区的划分，主要分为5部分：方法区，堆，程序计数器，虚拟机栈，本地方法栈。

a.程序计数器（线程独有）

指向当前线程正在执行的字节码指令地址。程序计数器是线程独享的，每个线程都有自己的程序计数器。

注：在JVM中最小的执行单元是线程，在多线程编程条件下，每个线程执行时有自己的独立性。cpu可能被更高优先级的线程打断，线程会被中断，当再次切换到该线程时，需要cpu知道线程执行到了什么地方。

b.虚拟机栈（线程独有）

存储当前线程运行方法所需要的数据（局部变量），指令和返回地址。方法是由线程来执行的，因此虚拟机栈也是线程独享的，即每个线程都有自己的虚拟机栈。虚拟机栈的单位是栈帧。

栈帧包含了方法执行时需要的数据，指令和控制。包括局部变量表（在编译期就可以确定大小，局部变量的数据类型是确定的），操作数栈（涉及到方法中的数据的入栈出栈操作），动态链接，出口（正常返回和异常返回）等。

注：XSS是虚拟机栈的最大深度。超过后抛出stackOverFlow异常。虚拟机栈的深度在每个线程中都是相同的，因此虚拟机栈的大小对于每个线程都是不同的，因为栈帧大小不是固定不变的。

注2：局部变量长度是32位，那么long和double如何存储，这种类型需要占2个空间。

线程安全问题：

虚拟机栈都是线程独享的，虚拟机中的栈帧包含了执行方法体的信息。当栈帧中的变量引用了堆空间中的对象时，并且该对象是在线程间共享时就会出现多线程安全问题。

c.本地方法栈（线程独有）

native方法执行时就会用到，本地方法栈与虚拟机栈是类似的，也是线程独有的。

d.方法区（线程共享）

存储类信息（生成实例时相当于对象的模板），常量（1.7移到了堆中），静态变量，JIT编译代码（动态代理）。

e.堆（线程独有）

即JMM（JVM内存模型），分代：新生代，老年代，永久代。新生代又分三个区域，eden，s0，s1（分为8:1:1）

注：堆为了方便垃圾回收，设计成分代分区的结构。