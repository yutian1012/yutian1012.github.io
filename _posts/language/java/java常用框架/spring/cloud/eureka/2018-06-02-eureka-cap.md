---
title: spring cloud eureka与CAP
tags: [spring]
---

1）理解CAP（理论应用于分布式数据库和分布式系统）

传统关系型数据库（mysql/oracle/sqlserver）中有ACID的理念（指数据库事务正确执行的四个基本要素的缩写）。而在NoSQL数据库（redis/mongodb）与之对应的理念就是CAP。

A（Atomicity原子性）C（Consistency一致性）I（Isolation隔离性）D（Durability持久性）

C（Consistency强一致性）A（Avaliability可用性）P（Partition-tolerance分区容错性）

2）原理

CAP理论的核心是：一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求。因此，根据CAP原理NoSQL数据库分成了满足CA原则，满足CP原则和满足AP原则三大类。

CA，单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大。
CP，满足一致性，分区容错性的系统，通常性能不是特别高
AP，满足可用性，分区容错性，通常可能对一致性要求要低一些。

CAP原理图

![](/images/spring/springcloud/eureka/cap.jpg)

3）分区容错性：

P (分区容错性) 指的是系统一部分不可用，不会影响其它部分。由于当前的网络硬件肯定会出现延迟丢包等问题，所以分区容忍性是必须要实现的。

注：在分布式系统中，由于部署不可能是一台机器，因此P一定要满足。

2）eureak与zookeeper的区别

eureka遵守AP原则，zookeeper遵守CP原则

a.zookeeper如何保证CP

ZooKeeper是个集群，内部有多个server，每个server都可以连接多个client，每个client都可以修改server中的数据，ZooKeeper可以保证每个server内的数据完全一致，是如何实现的呢？

Zookeeper是一个由多个Server组成的集群，该集群有一个Leader，多个Follower。客户端可以连接任意ZooKeeper服务节点来读写数据。ZK集群中每个Server，都保存一份数据副本。Zookeeper使用简单的同步策略，通过以下两条基本保证来实现数据的一致性：所有的读请求由Zk-Server本地响应，所有的更新请求将转发给Leader，由Leader实施。

```
全局串行化所有的写操作

保证同一客户端的指令被FIFO执行（以及消息通知的FIFO）
```

b.zookeeper保存CP的问题

当向注册中心查询服务列表时，我们可以容忍注册中心返回的是几分钟以前的注册信息，但不能接受注册中心服务直接down掉不可用。也就是说，服务注册功能对可用性的要求要高于一致性。但是zk会出现这样一种情况，当master节点因为网络故障与其他节点失去联系时，剩余节点会重新进行leader选举。问题在于，选举leader的时间太长，30-120s，且选举期间整个zk集群都是不可用的，这就导致在选举期间注册服务瘫痪。在云部署的环境下，因网络问题使得zk集群失去master节点是较大概率会发生的事，虽然服务能够最终恢复，但是漫长的选举时间导致的注册长期不可用是不能容忍的。

c. Eureka保证AP

Eureka可以很好的应对网络故障导致部分注册中心节点失去联系的情况，而不会像zookeeper那样使整个注册服务瘫痪。

Eureka在设计时优先保证可用性。Eureka各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。而Eureka的客户端在想某个Eureka注册时，如果发现连接失败，则会自动切换到其他节点。只要有一台Eureka还在，就能保证注册服务可用（可用性保证方式）。只不过查到的信息可能不是最新的（不保证强一致性）。除此之外，Eureka还有一种自我保护机制，如果在15分钟内超过85%的节点都没有正常的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，此时会出现以下几种情况：

```
Eureka不会从注册列表中移除因为长时间没有收到心跳而应该过期的服务（好死不如赖活着）

Eureka仍然能接受新服务的注册和查询请求，但这些注册信息不会同步到其他节点（值保证当前亟待依然可用）

当网络稳定时，当前实例新的注册信息会被同步到其他节点中。
```