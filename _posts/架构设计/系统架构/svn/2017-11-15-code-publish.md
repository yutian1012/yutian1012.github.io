---
title: 代码发布架构
tags: [architecture]
---

### 系统发布所需要做的工作

运维工程师：安装优化软件环境（nginx，lvs）

开发工程师：程序代码，已经代码的不断更新

运维工程师：软件信息配置及变更。

### 代码上线解决方案

1）小企业代码上线流程图

代码的发布完全有手工替换，通过ftp上传代码，然后替换相应的代码程序，完成新版本的发布。

![](images/architecture/svn/code-publish/small-publish.png)

注：这种方式的发布缺陷很大，代码一旦有问题，会严重影响用户的使用。

方案建议：

线上更新代码的思路：代码上线前需要备份，如果网站程序出现问题方便回退。上传代码时尽可能先传到服务器网站临时目录，传完整后一步mv过去，这样的替换程序是最快的，如果直接拷贝文件到目标目录比较慢，影响正在使用的用户。

尽量由运维人管理上下。否则，开发随意更新，出了问题运维负责，这是不公平的。

2）中型企业上线解决方案

一般是规范运维人员操作步骤，制定统一的上线脚本，备份文件名称，备份文件路径。使操作人性化，统一化，自动化。

![](images/architecture/svn/code-publish/middle-publish.png)

注：中型比小型多了运维人员的管理职能。

3）大型企业上线解决方案

![](images/architecture/svn/code-publish/big-publish.png)

svn服务中放置了程序代码，服务的配置以及项目设计/部署文档等。

Jenkins平台是一个web管理平台，能够自动把svn中的代码发布到办公开发环境中（办公室测试环境）。办公开发环境的配置也是jenkins从svn获取的配置信息进行配置的。办公室开发环境测试没有问题后（测试人员进行了测试）。

配置管理员将代码编译好，将编译打包程序和配置信息推送到IDC统一分发管理服务器。

运维人员通过IDC统一分发管理服务器把编译好的包推送到IDC测试环境，开发测试人员在IDC测试环境中测试。

IDC测试通过后，由运维人员将代码推送到IDC正式环境，分组平滑上线（一般分为2组）。

正式环境的上线过程（平滑上线）：集群环境下的系统，如使用lvs作为负载均衡。首先会将集群环境下的服务器进行分组，分为2组（A组和B组）。首先将A组从正式环境的LVS上下线，更新代码以及相连接的数据库等服务，更新完成后，将A组挂接到测试环境下的lvs，有测试人员测试。如果测试通过，则将A组从测试环境的lvs上下线，挂接到正式环境的lvs上。这样A组的代码就被更新成功了。同时将B组在正式环境的lvs上下线，通过相同的步骤完成更新并上线。

注：上线一般分为两组进行上线，原因是如果分为多组上线，会存在新旧版本同时共存的问题，可能会造成一些程序上的bug。

注2：代码修改后会经过4套环境的检验，开发人员本地环境测试（开发人员自己测试），办公室开发环境（测试人员测试），IDC测试环境（测试人员测试），IDC正式环境。四个环境的配置和软件都是相同的。

注3：打包编译一般使用maven和ant来打包，可以自动打包。