---
title: 代码发布架构
tags: [architecture]
---

参考：http://blog.51cto.com/linuxzkq/1867490

### 系统发布所需要做的工作

运维工程师：安装优化软件环境（nginx，lvs）

开发工程师：程序代码，已经代码的不断更新

运维工程师：软件信息配置及变更。

配置管理员：就是在开发和运维中间起一个连接纽带的一个职位，这个职位一般在大公司里会设置，负责SVN的管理，上线管理，流程申请，业务协调等工作。

### 代码上线解决方案

1）小企业代码上线流程图

代码的发布完全有手工替换，通过ftp上传代码，然后替换相应的代码程序，完成新版本的发布。

![](images/architecture/svn/code-publish/small-publish.png)

注：这种方式的发布缺陷很大，代码一旦有问题，会严重影响用户的使用。

方案建议：

线上更新代码的思路：代码上线前需要备份，如果网站程序出现问题方便回退。上传代码时尽可能先传到服务器网站临时目录，传完整后一步mv过去，这样的替换程序是最快的，如果直接拷贝文件到目标目录比较慢，影响正在使用的用户。

尽量由运维人管理上下。否则，开发随意更新，出了问题运维负责，这是不公平的。

2）中型企业上线解决方案

一般是规范运维人员操作步骤，制定统一的上线脚本，备份文件名称，备份文件路径。使操作人性化，统一化，自动化。

![](images/architecture/svn/code-publish/middle-publish.png)

注：中型比小型多了运维人员的管理职能。

3）大型企业上线解决方案

![](images/architecture/svn/code-publish/big-publish.png)

svn服务中放置了程序代码，服务的配置以及项目设计/部署文档等。

Jenkins平台是一个web管理平台，能够自动把svn中的代码发布到办公开发环境中（办公室测试环境）。办公开发环境的配置也是jenkins从svn获取的配置信息进行配置的。办公室开发环境测试没有问题后（测试人员进行了测试）。

配置管理员将代码编译好，将编译打包程序和配置信息推送到IDC统一分发管理服务器。

运维人员通过IDC统一分发管理服务器把编译好的包推送到IDC测试环境，开发测试人员在IDC测试环境中测试。

IDC测试通过后，由运维人员将代码推送到IDC正式环境，分组平滑上线（一般分为2组）。

正式环境的上线过程（平滑上线）：集群环境下的系统，如使用lvs作为负载均衡。首先会将集群环境下的服务器进行分组，分为2组（A组和B组）。首先将A组从正式环境的LVS上下线，更新代码以及相连接的数据库等服务，更新完成后，将A组挂接到测试环境下的lvs，有测试人员测试。如果测试通过，则将A组从测试环境的lvs上下线，挂接到正式环境的lvs上。这样A组的代码就被更新成功了。同时将B组在正式环境的lvs上下线，通过相同的步骤完成更新并上线。

注：上线一般分为两组进行上线，原因是如果分为多组上线，会存在新旧版本同时共存的问题，可能会造成一些程序上的bug。

注2：代码修改后会经过4套环境的检验，开发人员本地环境测试（开发人员自己测试），办公室开发环境（测试人员测试），IDC测试环境（测试人员测试），IDC正式环境。四个环境的配置和软件都是相同的。

注3：打包编译一般使用maven和ant来打包，可以自动打包。

### 大型企业上线的操作流程

一般制度和流程控制较多，比较严谨。
1.特别是JAVA代码环境，上线时，有数台机器同时需要更新或者分批更新：

1).本地开发人员取svn代码。当天上线提交到trunk，否则，长期项目单开分支开发，然后在合并主线(trunk)

2).办公内网开发测试时，由开发人员或配置管理员通过部署平台jenkins实现统一部署，（即在部署平台上控制开发机器从svn取代码，编译，打包，发布到开发机，包名如idc_dep.war）.

3).开发人员通知或和测试人员一起测试程序，没有问题后，由配置管理员打上新的tag标记。这里要注意，不同环境的配置文件是随代码同时发布的。

4).配置管理员，根据上一步的tag标记，checkout出上线代码，并配置好IDC测试环境的所有配置，执行编译，打包(mvn,ant)(php不需要打包)，然后发布到IDC内的统一分发服务器。

5).配置管理员或SA上线人员，把分发的程序代码内容推送到相关测试服务器（包名如idc_test.war），然后通知开发及测试人员进行测试。如果有问题向上回退，继续修改。

6).如果IDC测试没有问题，继续打好tag标记，此时，配置管理员，根据上步的tag标记，checkout出测试好的代码，并配置好IDC正式环境的所有配置，执行编译，打包(mvn,ant)(php不需要打包)，然后发布到IDC内的统一分发服务器主机，准备批量发布。

7).配置管理员或SA上线人员，把分发的内容推送到相关正式服务器（包名如idc_product.war）,然后通知开发及测试人员进行测试。如果有问题直接发布回滚指令。
   
注：IDC正式上线的过程对于JAVA程序，可以是AB组分组上线的思路，即平滑下线一半的服务器，然后发布更新代码，重启测试，无问题后，挂上更新后的服务器，同时再平滑下线另一半的服务器，然后发布更新代码测试（或者直接发布后，重启，挂上线）

注2：灰度发布，如果前端有DNS智能解析，上线还可以分地区上线若干服务器，逐渐普及到全国的服务器，这个被称为"灰度发布";

### 代码上线解决方案注意事项：

1).上线的流程里，办公室测试环境-->IDC测试环境-->正式生产环境，所有环境中的所有软件均应版本统一，其次尽量单一，否则将后患无穷，开发测试成功，IDC测试就可能有问题（如:操作系统，web服务器，jdk,php,tomcat,resin等版本）

2).开发团队小组办公内部测试环境测试（该测试环境属于开发小组维护，或定时自动更新代码），代码有问题返回给某开发人员重新开发。

3).有专门的测试工程师，程序有问题直接返回给开发人员（此时返回的一般为程序的BUG，称为BUG库），无问题进行IDC测试

4).IDC测试由测试人员和运维人员参与，叫IDCtest,进行程序的压力测试，有问题直接返回给开发人员，无问题进行线上环境上线。

5).数台服务器代码分发上线方案举例（JAVA程序）

   A:假设同业务服务器有6台，将服务器分为A,B两组，A组三台，B组三台，先对A组进行从负载均衡器上平滑下线，B组正常提供服务，避免服务器因上线影响业务。
   B:下线过程是通过脚本将A组服务器从RS池（LVS,NGINX,HAPROXY,F5等均有平滑方案）中踢出，避免负裁均衡器将请求发送给A组服务器（此时的时间应该为网站流量少时，一般为晚上）
   C:将代码分发到A组服务器的站点目录下，对A组服务器上线并重启服务，并由专业的测试人员进行访问测试，测试成功后，挂上A组的服务器，同时下线B组服务器，B组代码上线操作测试等和A组相同，期间也要观察上线提供服务的服务器状况，有问题及时回滚。

6).特别说明：如果是PHP程序，则上线可以简单化，直接将上线代码（最好全量）发布到所有上线服务器的特定目录后，分发完成后，一次性mv或ln到站点目录，当然测试也是少不了的。测试除了人员测试外，还有各种测试脚本测试各个相关业务接口。

7).大多数门户公司的前端页面都已经静态化或者cache了，因此，动态的部分访问平时就不会特别多，流量低谷时就更少了。再加上是平滑上下线，因此基本上是对用户体验无影响的，当然，也有上线出问题的情况，这个是避免不了的。

8)SVN上包含代码和配置

  (1)、SVN上存放程序代码（不含资源，大公司基本资源包括图片文件用户上传内容等和程序都是分离的）
   尽可能全量上线的原因：因为我们务必要保证SVN的代码是最新的。
  
  (2)、存放所有服务的配置文件(LAMP环境，如：apache的httpd.conf配置文件)，在上线不同环境时，由配置管理员协调上线

    a)、开发小组测试环境使用的配置文件
    b)、办公测试环使用配置文件
    c)、IDC测试使用的配置文件
    d)、线上应用使用的配置文件
