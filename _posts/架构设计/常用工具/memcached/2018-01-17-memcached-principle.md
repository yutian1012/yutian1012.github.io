---
title: memcached工作原理
tags: [memecached]
---

1）memcached工作原理

memcached是一套C/S模式架构的软件，在服务器端启动memcached服务守护进程，可以指定监听的ip地址、端口号，并发访问连接数以及分配多少内存来处理客户端的请求。

2）socket事件处理机制

memcached采用的是异步epoll/kqueue非阻塞I/O网络模型。其实现方式是基于异步的libevent事件单进程、单线程模式。使用libevent作为事件通知机制。应用程序端通过指定缓存服务器的ip地址和端口，就可以连接memcached服务互相通信。

3）数据存储机制

被缓存的数据以key/value键值对的形式保存在服务器端预分配的内存区中，每个被缓存的数据都有唯一的标识key，操作memcached中的数据通过这个唯一标识的key进行。

4）支持多线程

需要编译时开启：./configure --enable-threads，但锁机制locking不够完善。

### memcached预热

如果系统被大流量拖垮了，造成数据库启动不起来，memcached没有数据可查询，此时该如何处理？

首先需要在应用服务器的负载均衡处，将大流量拦截下来，然后启动数据库，通过多线程的方式将数据库的内容导入到memcached集群中（这个过程称为预热）。然后再到负载均衡处把应用挂载上，完成网站的启动。

注：断电对大型网站的影响是很大的，需要从后端依次往前端启动，缓存服务器要预热。

注2：关闭系统是从前向后，先关负载均衡，再关缓存服务器，最后关闭数据库。

### 分享一个带宽暴涨的问题解决

实践：服务器无法连接，IDC机房带宽暴涨（老男孩）

参考：http://blog.51cto.com/oldboy/909696

机房上连口网线拔掉，过5分钟再插上去，查看机房提供的监控（上连口信息）。查看自己的监控，定位到服务器，是每个服务器流量都有增加还是只有一个流量增加。最后找到服务器外发流量，使整个带宽被占满，导致系统无法响应用户的请求。