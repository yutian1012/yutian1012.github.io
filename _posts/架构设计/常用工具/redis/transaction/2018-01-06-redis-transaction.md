---
title: redis事务
tags: [redis]
---

redis的事务是比较简单的，从某种意义上讲redis不支持事务回滚。

1）事务三阶段

一个事务从开始到执行会经历三个阶段：

a.开始事务，使用multi命令

b.命令入队，输入的所有命令都会被存放到队列中（同一个客户端）

c.执行事务，使用exec命令

2）事务操作过程

a.批量操作在发送EXEC命令前被放入队列缓存。

b.收到EXEC命令后进入事务执行，事务中任意命令执行失败，其余的命令依然被执行。

c.在事务执行过程，其他客户端提交的命令请求不会插入到事务执行命令序列中。

3）存在问题

开启事务后将要执行的语句会放置到队列queue中，如果队列中语句本身没有语法错误，而因为某个操作的变量类型不匹配而失败，exec执行队列命令后，最终能够执行的语句会正常执行，而类型不匹配导致错误的语句不会执行，并且抛出错误。这个错误被redis跳过了，没有整体回滚事务，而正常执行的语句却是成功的。再次执行discard也不能回滚已经成功执行了的语句。

exec时，会执行队列中已存在的命令，并且会关闭掉队列queue，此时不允许再向queue中添加任何命令。

4）实现同步的方法

watch命令可以监视对象，与事务命令配合实现同步操作，当watch监视的变量发生了变化，该事务中的语句会回滚。

unwatch命令能够取消监视的对象。