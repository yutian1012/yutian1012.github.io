---
title: redis事务回滚问题
tags: [redis]
---

multi后面的语句中，语句出错有2种情况：

a.语法存在问题；这种方式能够回滚队列中的操作语句。

b.语法本身没有问题，但适用对象有问题；这种方式不能正确回滚已经正确执行的语句。

注：手动执行discard命令进行回滚，回滚操作必须要在exec命令前，否则是无法回滚已经正确执行的命令。

1）语法问题的回滚操作

这种情况下，执行exec时会报错，所有语句得不到执行，即能够回滚了队列中已经成功执行的语句。

```
flushdb

# 初始化数据
set wang 200
set zhao 700

# 启动事务
multi

# 执行转账，会将语句先放置到queue中
decryby zhao 100

# 执行一个不存在的命令，导致语法错误
asdf

# 执行提交，这时会报错，并且事务进行了回滚
exec
```

2）针对类型不匹配操作的错误

这种方式语句的语法本身没有问题，但操作类型不匹配，exec会执行正确的语句，并跳过不适当的语句，这样就无法保证事务的原子性。

```
flushdb

# 初始化数据
set wang 200
set zhao 700

# 启动事务
multi

# 执行转账，会将语句先放置到queue中
decryby zhao 100

# 执行sadd向集合中添加元素a，但wang是一个字符串类型的数据，并不是集合，因此报错
sadd wang a

# 执行提交，这时会报错，但事务不会回滚
exec
```

3）执行discard命令进行回滚

```
flushdb

# 初始化数据
set wang 200
set zhao 700

# 启动事务
multi

# 执行转账，会将语句先放置到queue中
decryby zhao 100

# 回滚，取消队列中的命令
discard
```