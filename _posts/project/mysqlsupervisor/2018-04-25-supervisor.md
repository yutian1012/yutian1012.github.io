---
title: mysql监控工具
tags: [project]
---

问题：项目在开发过程中，经常出现一部分已经上线，一部分正在开发，并且开发的功能可能在数据库结构上对已经上下的系统有影响。而这部分影响包括数据结构的变化以及数据初始的处理。而每次替换程序都会面临着如何整合数据的问题。即保留线上的数据，同时又需要对线下的变更进行整合。

线上的用户、组织和角色，以及一些系统配置数据都是需要保留的，而线下的数据一些新增的初始数据，结构变动需要同步的更新到线上环境。每次更新都需要一张表一张表的处理，非常麻烦。

正确的做法，上线的功能在修改后要以bug的方式进行快速的修复，不要等到其他功能完成后在修复。保证新上线功能的独立性，这样再部署系统时，能够有针对性的处理。另外，对于系统的全局的配置初始信息的修改，需要做好记录。记录好变更sql，到时候统一执行。

存在的问题：很少有开发人员会主动记录所有sql的变更，导致最终部署系统时不能正确的找到要执行的sql。唯一的办法就只能整个库全部覆盖，然后再有针对性的对线上数据进行恢复。如果在恢复过程中存在相同表数据不一致的问题，就更麻烦了。

解决思路：

创建一个监控工具，用来实时监控数据库的变动，可通过binlog日志来实现。定期分析binlog日志的信息，提取出自己需要的变更sql。包括alter修改数据表结构的语句，create创建数据表的语句，配置表以及相关重要表的insert和update语句。通过监控数据库的变更操作，按顺序记录下变更记录，最终部署系统时，将这段时间内的变更sql提取出来，在线上的数据库中执行，从而保证系统的数据结构的升级。

navicat中也提供了数据同步功能，需要高版本的navicat才可以正常使用。如navicat-12版，能够比较两个数据库表（将线上的数据库和线下的数据库都放置到一个服务器上），根据数据表的主键进行比较，并提示出表间的不同信息，可选择保留的数据和更新的数据，最终会导出一个sql语句。

执行过程：首先进行结构同步（工具--结构同步），目的是找出数据库结构的变化。然后进行数据同步（工具--数据同步），目的是改变的找出不同数据。

注：对于主键不存在的数据表，不会进行同步操作。

慢查询问题，监控sql的慢查询，并记录执行sql的时间点，查找原因。
